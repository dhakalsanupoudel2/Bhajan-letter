<!DOCTYPE html>
<html lang="ne">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>рдж рдХреЗрдпрд░ рдлрд╛рдЙрдиреНрдбреЗрд╕рди тАУ рдкрддреНрд░ (PWA)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111827" />
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --shadow:0 10px 25px rgba(0,0,0,.06);
            --page-w:794px; --page-h:1123px; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:'Noto Sans Devanagari','Mangal','Kalimati','Nirmala UI','Hind',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    header{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .badge{background:#111827;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:12px}
    label{display:block;color:var(--muted);font-size:14px;margin:8px 0 4px}
    input{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 140px 40px;gap:8px;align-items:center;margin-bottom:8px}
    .row .remove{height:44px;border:1px solid #fecaca;background:#fee2e2;border-radius:10px;color:#991b1b}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:15px}
    button.secondary{background:#f3f4f6;color:#111;border:1px solid var(--border)}
    .page{width:var(--page-w);min-height:var(--page-h);margin:14px auto;background:#fff;border:1px solid var(--border);
          border-radius:10px;box-shadow:var(--shadow);padding:48px 56px}
    .brand{text-align:center;line-height:1.25;margin-bottom:10px}
    .brand .title{font-weight:700;font-size:20px}
    .brand .tag{color:#6b7280;font-size:13px;margin-top:4px}
    .brand .label{font-weight:700;font-size:15px;margin-top:6px}
    .meta{margin-top:12px;display:flex;justify-content:space-between;font-size:14px}
    .salutation{margin-top:16px;font-size:16px}
    .body p{font-size:16px;line-height:1.75;margin:14px 0}
    .section-title{font-weight:700;margin-top:12px}
    .list{list-style:none;padding-left:0;margin:10px 0 0}
    .list li{margin:6px 0;font-size:16px}
    .total{margin-top:8px;font-weight:700}
    @media print {.card,header,.btns{display:none!important}.page{border:none;box-shadow:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h3 style="margin:0">рдкрддреНрд░ рдЬреЗрдирд░реЗрдЯрд░ (PWA)</h3>
      <span class="badge" id="status">Offline ready</span>
    </header>

    <div class="card">
      <label for="priya">рдкреНрд░рд┐рдп (рдирд╛рдо)*</label>
      <input id="priya" placeholder="рдЬрд╕реНрддреИ: рд╢реНрд░реА/рд╢реНрд░реАрдорддреА ______">

      <label for="host">рдЖрдордиреНрддреНрд░рдХрдХреЛ рдпреЛрдЧрджрд╛рди (CAD)</label>
      <input id="host" type="number" inputmode="decimal" step="0.01" min="0" value="0">

      <label>рдкрд░рд┐рд╡рд╛рд░ рддрдерд╛ рдЕрддрд┐рдерд┐ рдорд╣рд╛рдиреБрднрд╛рд╡рд╣рд░реВрдХреЛ рдпреЛрдЧрджрд╛рди (рдирд╛рдо рд░ рд░рдХрдо)</label>
      <div id="rows"></div>
      <div class="btns">
        <button id="addRow" type="button">+ рдЕрд░реНрдХреЛ рдкрдЩреНрдХреНрддрд┐ рдердкреНрдиреБрд╣реЛрд╕реН</button>
        <button id="clearRows" class="secondary" type="button">рд╕рдмреИ рдЕрддрд┐рдерд┐ рдЦрд╛рд▓реА</button>
      </div>

      <div class="btns">
        <button id="refresh" type="button">рдкрддреНрд░ рдЕрдкрдбреЗрдЯ</button>
        <button id="downloadJpg" class="secondary" type="button">JPEG рдбрд╛рдЙрдирд▓реЛрдб</button>
        <button id="printBtn" class="secondary" type="button">Print / Save as PDF</button>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">рдорд┐рддрд┐ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд; рд░рдХрдорд╣рд░реВ рдЖрдлреИрдБ рдЬрдореНрдорд╛ рд╣реБрдиреНрдЫрдиреНред</div>
    </div>

    <div id="page" class="page">
      <div class="brand">
        <div class="title">рдж рдХреЗрдпрд░ рдлрд╛рдЙрдиреНрдбреЗрд╕рди (рдПрдбрдореЛрдиреНрдЯрди рд╕рд╛рдереА рд╕рд╣рдпреЛрдЧреА рд╕рдореВрд╣)</div>
        <div class="tag">Compassion тАв Integrity тАв Service</div>
        <div class="label">ЁЯУН Letter of Appreciation & Donation Acknowledgment</div>
      </div>
      <div class="meta">
        <div>рдорд┐рддрд┐: <span id="date"></span></div><div></div>
      </div>
      <div class="salutation">рдкреНрд░рд┐рдп <span id="priyaOut" style="font-weight:600;">____________________________</span>,</div>
      <div class="body">
        <p>рдж рдХреЗрдпрд░ рдлрд╛рдЙрдиреНрдбреЗрд╕рди (рдПрдбрдореЛрдиреНрдЯрди рд╕рд╣рдпреЛрдЧреА рд╕рдореВрд╣) рддрд░реНрдлрдмрд╛рдЯ, рддрдкрд╛рдИрдВ рд░ рддрдкрд╛рдИрдВрдХреЛ рдкрд░рд┐рд╡рд╛рд░рд▓рд╛рдИ рд╣рд╛рдореНрд░реЛ рднрдЬрди рдХрд╛рд░реНрдпрдХреНрд░рдордХрд╛ рд▓рд╛рдЧрд┐ рдЖрдлреНрдиреИ рдШрд░рдорд╛ рд╕реНрд╡рд╛рдЧрдд рдЧрд░реНрдиреБрднрдПрдХреЛрдорд╛ рд╣рд╛рд░реНрджрд┐рдХ рдзрдиреНрдпрд╡рд╛рдж рджрд┐рди рдЪрд╛рд╣рдиреНрдЫреМрдБред рддрдкрд╛рдИрдВрдХреЛ рдЖрддреНрдореАрдп рдЖрддрд┐рдереНрдп рд░ рдЙрджрд╛рд░ рдпреЛрдЧрджрд╛рдирд▓реЗ рд╣рд╛рдореНрд░реЛ рдорд┐рд╢рдирд▓рд╛рдИ рдордЬрдмреБрдд рдмрдирд╛рдПрдХреЛ рдЫтАФрдиреЗрдкрд╛рд▓рдорд╛ рдЧрд░рд┐рдм рддрдерд╛ рд╡рд┐рдкрдиреНрди рдорд╛рдирд┐рд╕рд╣рд░реВрд▓рд╛рдИ рд╕рд╣рдпреЛрдЧ рдЧрд░реНрдиреЗ, рд╡рд┐рд╢реЗрд╖ рдЧрд░реА рдЙрдкрдЪрд╛рд░ рдкрд╛рдЙрди рдЖрд░реНрдерд┐рдХ рдкрд╣реБрдБрдЪ рдирднрдПрдХрд╛ рдмрд┐рд░рд╛рдореАрд╣рд░реВ, рдЕрдирд╛рде рдмрд╛рд▓рдмрд╛рд▓рд┐рдХрд╛ рд░ рдЕрд╕рд╣рд╛рдп рд╡реГрджреНрдз рд╡реНрдпрдХреНрддрд┐рд╣рд░реВрд▓рд╛рдИ рд╕рд╣рдпреЛрдЧ рдкреБрд░реНтАНрдпрд╛рдЙрдиреЗ рд╣рд╛рдореНрд░реЛ рдЕрднрд┐рдпрд╛рдирд▓рд╛рдИ рдирд┐рд░рдиреНрддрд░рддрд╛ рджрд┐рди рддрдкрд╛рдИрдВрдХреЛ рдпреЛрдЧрджрд╛рди рдЕрдореВрд▓реНрдп рд░рд╣реЗрдХреЛ рдЫред</p>
        <p>рддрдкрд╛рдИрдВрдХреЛ рдирд┐рд╡рд╛рд╕рд╕реНрдерд╛рдирдорд╛ рд╕рдореНрдкрдиреНрди рднрдЬрди рдХрд╛рд░реНрдпрдХреНрд░рдордорд╛рд░реНрдлрдд рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд╣рдпреЛрдЧ рд░рдХрдо рдкреНрд░рд╛рдкреНрдд рднрдПрдХреЛ рдЬрд╛рдирдХрд╛рд░реА рдЧрд░рд╛рдЗрдиреНрдЫрдГ</p>
        <p class="section-title">рдЖрдордиреНрддреНрд░рдХрдХреЛ рдпреЛрдЧрджрд╛рди: <span id="hostOut">0.00</span> CAD</p>
        <div class="section-title">рдкрд░рд┐рд╡рд╛рд░ рддрдерд╛ рдЕрддрд┐рдерд┐ рдорд╣рд╛рдиреБрднрд╛рд╡рд╣рд░реВрдХреЛ рдпреЛрдЧрджрд╛рди:</div>
        <ul id="guestList" class="list">
          <li>тАв ____________________________</li>
          <li>тАв ____________________________</li>
          <li>тАв ____________________________</li>
        </ul>
        <div class="total">рдХреБрд▓ рд╕рдВрдХрд▓рд┐рдд рд░рдХрдо: <span id="totalOut">0.00</span> CAD</div>
        <p>рдпреЛ рдЕрдореВрд▓реНрдп рд╕рд╣рдпреЛрдЧ рд╣рд╛рдореАрд▓реЗ рдкреНрд░рд╛рдердорд┐рдХрддрд╛рдХрд╛ рд╕рд╛рде рдЙрдкрдЪрд╛рд░ рдЦрд░реНрдЪрдХрд╛ рд▓рд╛рдЧрд┐ рдкреНрд░рдпреЛрдЧ рдЧрд░реНрдиреЗрдЫреМрдБред рд╕рд╛рдереИ, рдпрд╕рдмрд╛рдЯ рдЕрд╕рд╣рд╛рдп рдЕрдирд╛рде рдмрд╛рд▓рдмрд╛рд▓рд┐рдХрд╛ рд░ рд╡реГрджреНрдз рд╡реНрдпрдХреНрддрд┐рд╣рд░реВрд▓рд╛рдИ рдкрдирд┐ рд╕рд╣рдпреЛрдЧ рдкреБрдЧреНрдиреЗрдЫред</p>
        <p>рд╣рд╛рдореА рддрдкрд╛рдИрдВрдХреЛ рдирд┐рд░рдиреНрддрд░ рд╕рд╛рде рд░ рдЙрджрд╛рд░ рд╕рдорд░реНрдердирдкреНрд░рддрд┐ рд╣рд╛рд░реНрджрд┐рдХ рдЖрднрд╛рд░ рд╡реНрдпрдХреНрдд рдЧрд░реНрджрдЫреМрдБ, рдЬрд╕рд▓реЗ рд╣рд╛рдореНрд░реЛ рд╕реЗрд╡рд╛рднрд╛рд╡ рд░ рдорд╛рдирд╡реАрдп рдЕрднрд┐рдпрд╛рдирд▓рд╛рдИ рдЕрдЭ рд╕рд╢рдХреНрдд рд░ рд╕реНрдерд╛рдпреА рдмрдирд╛рдЙрди рдорд╣рддреНрд╡рдкреВрд░реНрдг рднреВрдорд┐рдХрд╛ рдЦреЗрд▓реЗрдХреЛ рдЫред</p>
        <div style="margin-top:24px">рд╣рд╛рд░реНрджрд┐рдХ рдХреГрддрдЬреНрдЮрддрд╛ рд╕рд╣рд┐рдд,</div>
        <div style="font-weight:700;margin-top:10px">рдж рдХреЗрдпрд░ рдлрд╛рдЙрдиреНрдбреЗрд╕рди</div>
      </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }
    const $ = (id)=>document.getElementById(id);
    const priyaIn=$('priya'), hostIn=$('host'), rowsEl=$('rows');
    const priyaOut=$('priyaOut'), hostOut=$('hostOut'), guestList=$('guestList'), totalOut=$('totalOut'), dateOut=$('date');
    const refreshBtn=$('refresh'), addRowBtn=$('addRow'), clearRowsBtn=$('clearRows'), dlBtn=$('downloadJpg'), printBtn=$('printBtn');

    function addRow(name='',amount=''){
      const row=document.createElement('div'); row.className='row';
      const nameInput=document.createElement('input'); nameInput.placeholder='рдирд╛рдо'; nameInput.value=name;
      const amtInput=document.createElement('input'); amtInput.type='number'; amtInput.inputMode='decimal'; amtInput.step='0.01'; amtInput.min='0'; amtInput.placeholder='рд░рдХрдо (CAD)'; amtInput.value=amount;
      const x=document.createElement('button'); x.type='button'; x.className='remove'; x.textContent='├Ч';
      [nameInput, amtInput].forEach(el => ['input','change','keyup','blur'].forEach(ev=>el.addEventListener(ev, render, {passive:true})));
      x.addEventListener('click', ()=>{ rowsEl.removeChild(row); render(); });
      row.appendChild(nameInput); row.appendChild(amtInput); row.appendChild(x);
      rowsEl.appendChild(row);
    }
    function readGuests(){
      return [...rowsEl.querySelectorAll('.row')].map(r=>{
        const [n,a]=r.querySelectorAll('input');
        const name=(n.value||'').trim();
        const amt=parseFloat(a.value);
        return {name, amount: Number.isFinite(amt)?amt:0};
      }).filter(x=>x.name || x.amount>0);
    }
    function nepDate(d=new Date()){ try{return d.toLocaleDateString('ne-NP',{year:'numeric',month:'long',day:'numeric'})}catch(e){return d.toISOString().slice(0,10);}}
    function render(){
      dateOut.textContent = nepDate(new Date());
      priyaOut.textContent = (priyaIn.value||'____________________________').trim() || '____________________________';
      const hostAmt = parseFloat(hostIn.value); const hostNum = Number.isFinite(hostAmt)?hostAmt:0;
      hostOut.textContent = hostNum.toFixed(2);
      const guests = readGuests();
      guestList.innerHTML='';
      if(guests.length===0){
        for(let i=0;i<3;i++){ const li=document.createElement('li'); li.textContent='тАв ____________________________'; guestList.appendChild(li); }
      } else {
        guests.forEach(g=>{ const li=document.createElement('li'); li.textContent=`тАв ${g.name} тАУ ${g.amount.toFixed(2)} CAD`; guestList.appendChild(li); });
      }
      const total = guests.reduce((s,g)=>s+g.amount, hostNum);
      totalOut.textContent = total.toFixed(2);
    }
    // default 3 rows
    for(let i=0;i<3;i++) addRow();
    [priyaIn, hostIn].forEach(el=>['input','change','keyup'].forEach(ev=>el.addEventListener(ev, render, {passive:true})));
    addRowBtn.addEventListener('click', ()=>{ addRow(); render(); });
    clearRowsBtn.addEventListener('click', ()=>{ rowsEl.innerHTML=''; for(let i=0;i<3;i++) addRow(); render(); });
    refreshBtn.addEventListener('click', render);
    printBtn.addEventListener('click', ()=>window.print());
    render();

    // JPEG export via SVG foreignObject (iOS-friendly: opens new tab with image)
    function pageToJPEG(node, quality=0.95){
      const rect = node.getBoundingClientRect();
      const w = Math.ceil(rect.width), h = Math.ceil(rect.height);
      const styles = `<style>*{box-sizing:border-box}body{margin:0}.page{width:${w}px;min-height:${h}px;margin:0;background:#fff;padding:48px 56px;color:#111;font-family:'Noto Sans Devanagari','Mangal','Kalimati','Nirmala UI','Hind',Arial,sans-serif}.brand{text-align:center;line-height:1.25;margin-bottom:10px}.brand .title{font-weight:700;font-size:20px}.brand .tag{color:#6b7280;font-size:13px;margin-top:4px}.brand .label{font-weight:700;font-size:15px;margin-top:6px}.meta{margin-top:12px;display:flex;justify-content:space-between;font-size:14px}.salutation{margin-top:16px;font-size:16px}.body p{font-size:16px;line-height:1.75;margin:14px 0}.section-title{font-weight:700;margin-top:12px}.list{list-style:none;padding-left:0;margin:10px 0 0}.list li{margin:6px 0;font-size:16px}.total{margin-top:8px;font-weight:700}</style>`;
      const clone = node.cloneNode(true);
      const wrapper = document.createElement('div'); wrapper.setAttribute('xmlns','http://www.w3.org/1999/xhtml'); wrapper.appendChild(clone);
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><foreignObject x="0" y="0" width="${w}" height="${h}">${styles}${wrapper.outerHTML}</foreignObject></svg>`;
      const img = new Image(); const blob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'}); const url = URL.createObjectURL(blob);
      return new Promise((resolve,reject)=>{
        img.onload = () => {
          try{
            const canvas = document.createElement('canvas'); canvas.width=w*2; canvas.height=h*2;
            const ctx = canvas.getContext('2d'); ctx.scale(2,2); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
            URL.revokeObjectURL(url);
            const dataURL = canvas.toDataURL('image/jpeg', quality);
            const win = window.open(); if(win){ win.document.write('<img src=\"'+dataURL+'\" style=\"width:100%\">'); }
            resolve(true);
          }catch(err){ reject(err); }
        };
        img.onerror = e => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }
    $('downloadJpg').addEventListener('click', async ()=>{ render(); await pageToJPEG(document.getElementById('page')); }, {passive:true});
  </script>
</body>
</html>
